<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
	xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xmlns:xd="http://www.oxygenxml.com/ns/doc/xsl"
	exclude-result-prefixes="xs rsml svg"
	xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"
	xmlns:xlink="http://www.w3.org/1999/xlink" 
	xmlns:rsml="http://www.sleepingdog.org.uk/roadsign"
	xmlns:fn="http://www.w3.org/2005/xpath-functions"
	version="2.0">
	<xsl:output omit-xml-declaration="no" media-type="image/svg+xml" indent="yes" method="xml"/>
	<xsl:param name="centreX" select="'120'" />
	<xsl:param name="centreY" select="'120'" />
	<xd:doc scope="stylesheet">
		<xd:desc>
			<xd:p><xd:b>Created on:</xd:b> 2013-05-19</xd:p>
			<xd:p><xd:b>Last modified on:</xd:b> 2013-05-19</xd:p>
			<xd:p><xd:b>Author:</xd:b> SleepingDog</xd:p>
			<xd:p>Takes a Road Sign Markup Language document and outputs a SVG graphic.</xd:p>
			<xd:p>Notes:</xd:p>
			<xd:ul>
				<xd:li>This is a demonstrator for the Object-Match Question Type design pattern example
					http://www.sleepingdog.org.uk/learning/question/type/objectmatch/.</xd:li>
			</xd:ul>
		</xd:desc>
	</xd:doc>
	<xsl:template match="/">
		<svg version="1.1" x="0px" y="0px" width="240px" height="240px" viewBox="0 0 240 240">
			<xsl:comment><xsl:value-of select="rsml:roadsign/*/@*"></xsl:value-of></xsl:comment>		
			<xsl:apply-templates />
		</svg>
	</xsl:template>
	<xsl:template match="rsml:roadsign">
		<defs>
			<style type="text/css"><xsl:text>
				.shape{fill:</xsl:text><xsl:value-of
					select="rsml:background/@colour"/><xsl:text>;stroke:</xsl:text><xsl:value-of
						select="rsml:border/@colour"/><xsl:text>;stroke-width:24;stroke-linejoin:round;}
				.lighttext{fill:#FFFFFF;}
				.darktext{fill:#000000;}
				.redsymbol{fill:#ED1C24;}
				.blacksymbol{fill:#231F20;}
				.whitesymbol{fill:#FFFFFF;}
				.lighttextsymbol{fill:#FFFFFF;}
				.darktextsymbol{fill:#000000;}
			</xsl:text></style>
			<!-- Shapes: circle, square, triangle, inverted triangle -->
			<circle id="circle" cx="120" cy="120" r="106" /><!-- class="shape"-->
			<polygon id="octagon" points="74.17,9.36 165.77,9.36, 230.58,74.19 230.58,165.83 165.77,230.66 74.17,230.66
				9.37,165.83 9.37,74.19" /><!-- class="shape"-->
			<polygon id="triangle" points="228.6,218 120,30 11.4,218" /><!-- class="shape"-->
			<polygon id="inverted_triangle" points="228.6,22 120,210 11.4,22" /><!-- class="shape"-->
			<!-- Clip paths for the above so that other shapes are trimmed by their borders. -->
			<!-- Symbols. -->
			<g id="black_car+red_car">
				<path d="M106.027,112.685l-3.788-19.345c-0.385-2.11-2.934-6.34-8.078-6.34H55.712c-5.12,0-7.696,4.229-8.091,6.34
					l-3.703,19.278C41.506,113.054,39,115.55,39,118.111v15.952c0,2.341,2,4.377,3,5.065v11.643c2,1.511,3.227,2.57,5.354,2.57
					c2.107,0,4.646-1.125,5.646-2.57v-11.183L62.802,140h24.172L97,139.589v11.183c1,1.445,3.539,2.57,5.639,2.57
					c2.119,0,3.361-1.06,5.361-2.57v-11.643c1-0.688,3-2.725,3-5.065v-15.952C111,115.55,108.439,113.12,106.027,112.685z
					M95.958,109.721l-21.07-0.903l-20.997,0.903c-3.692,0.164-5.58-0.985-5.055-4.467l1.066-5.552C51.101,93.659,57.517,93,64.09,93
					h21.678c6.581,0,12.988,0.659,14.203,6.702l1.066,5.645C101.555,108.829,99.676,109.885,95.958,109.721z"/><!--  class="blacksymbol" -->
				<path class="redsymbol" d="M196.164,112.446l-3.821-19.299c-0.378-2.118-2.928-6.147-8.071-6.147H145.92c-5.137,0-7.713,4.029-8.082,6.147
					l-3.812,19.289c-2.421,0.46-5.025,2.885-5.025,5.446v15.952c0,2.356,2,4.311,3,5.066v11.576c2,1.584,3.243,2.635,5.344,2.635
					c2.052,0,4.656-1.133,5.656-2.635v-11.126L153.018,140h24.18l9.803-0.649v11.126c1,1.502,3.572,2.635,5.672,2.635
					c2.133,0,4.328-1.051,5.328-2.635V138.9c1-0.756,3-2.71,3-5.066v-15.952C201,115.32,198.56,112.906,196.164,112.446z
					M186.109,109.491l-21.006-0.903l-21.006,0.903c-3.767,0.155-5.661-0.978-5.144-4.532l1.065-5.872
					c1.289-6.06,7.705-7.087,14.203-7.087h21.762c6.563,0,12.996,1.028,14.194,7.087l1.066,5.768
					C191.763,108.41,189.866,109.646,186.109,109.491z"/>
			</g>
			<g id="down+left_arrow">
				<polyline points="148.149,156.664 103.634,156.664 198.684,61.581 176.348,39.228 81.303,134.319 81.225,89.628 
					47.693,123.188 47.693,190.216 114.695,190.216 148.149,156.664 "/><!--  class="whitesymbol" -->
			</g>
			<g id="bicycle">
				<path d="M70.56,110.453c2.785-9.318,5.582-18.627,8.386-28.027c0,0,0,0,0-0.107c0-0.106,0-0.205,0-0.205
					c0-0.484-0.201-0.894-0.594-0.992c0,0-0.09,0-0.201-0.107c-3.301-1.394-5.401-4.602-5.401-8.194c0-4.823,3.896-8.818,8.702-8.818
					c1.107,0,2.206,0,3.408,0c3.99,0,8.013,0,12.11,0c0,2.896,0,5.808,0,8.818c-3.608,0-7.304,0-11.007,0c-0.705,0-1.505,0-2.305,0
					c-0.5,0-1.099,0.492-1.099,1.091c0,0.402,0.201,0.706,0.488,0.902c0,0,0.111,0,0.217,0.09c2.698,1.599,4.602,3.51,4.602,6.726
					c0,1.386-0.107,1.887-0.5,3.191c-0.205,0.795-1.304,4.52-1.304,4.52c20.004,0,40.123,0,60.251,0
					c1.197-2.928,2.411-5.824,3.608-8.719c-4.511-1.107-9.014-2.313-13.615-3.502c-0.902-0.205-1.615-1.107-1.615-2.1
					c0-1.222,1.017-2.198,2.223-2.198c10.301,0,20.603,0,30.921,0c0,4.889-4.003,8.809-8.81,8.809c-1,2.485-2.001,5.094-3.1,7.71
					c3.806,6.997,7.611,14.1,11.417,21.203c3.903-1.591,8.186-2.395,12.4-2.395c18.323,0,33.136,14.821,33.136,33.039
					c0,18.3-14.812,33.113-33.136,33.113c-17.01,0-31.216-12.805-32.922-29.726c-1.304,0-2.607,0-3.904,0c0,0,0,0,0-0.099
					c-0.812,3.313-2.607,5.815-5.413,7.71c1.107,2.215,2.215,4.413,3.298,6.702c1.705,0,3.526,0,5.314,0c0,1.402,0,2.911,0,4.412
					c-1.197,0-2.395,0-3.609,0c-0.606,0.599-1.509,1.1-2.501,1.1c-0.91,0-1.796-0.402-2.502-1.1c-1.509,0-2.985,0-4.609,0
					c0-1.402,0-2.896,0-4.412c1.403,0,2.813,0,4.208,0c-0.895-1.69-1.797-3.396-2.698-5.192c0,0,0,0,0,0.09
					c-1.903,0.615-2.297,0.706-4.298,0.706c-7.308,0-13.32-5.996-13.32-13.305c0-1.312,0.217-2.616,0.611-3.806c0,0,0-0.106,0-0.205
					c-12.614-8.604-25.229-17.225-37.843-25.928c-0.312,1.107-0.705,2.305-1.107,3.502c0,0.099,0,0.205,0.106,0.304
					c8.3,6.414,12.91,15.699,12.91,26.133c0,18.3-14.923,33.113-33.123,33.113c-18.327,0-33.144-14.813-33.144-33.113
					c0-18.218,14.817-33.039,33.144-33.039c5.196,0,7.095,0.295,12,2.198C70.339,110.347,70.449,110.347,70.56,110.453 M121.292,141.188
					c0,4.896,3.9,8.892,8.813,8.892c4.806,0,8.792-3.995,8.792-8.892c0-4.814-3.986-8.81-8.792-8.81
					C125.192,132.378,121.292,136.373,121.292,141.188z M75.346,125.554c-0.496,1.911-1.107,3.806-1.689,5.823
					c-2.014,6.201-8.407,11.287-14.611,13.1c-0.222,0-0.521,0-0.706,0c-1.816,0-3.317-1.493-3.317-3.289c0-1.107,0.512-2.1,1.308-2.724
					c0.193-0.09,0.394-0.196,0.599-0.295c3.711-2.601,6.902-5.504,8.104-9.293c0.906-2.92,1.812-5.824,2.694-8.81c0,0,0,0,0-0.115
					c-2.879-1.189-6.086-1.895-9.387-1.895c-12.819,0-23.223,10.426-23.223,23.131c0,12.796,10.404,23.213,23.223,23.213
					c12.705,0,23.113-10.417,23.113-23.213c0-5.914-2.21-11.426-6.008-15.519C75.444,125.669,75.444,125.669,75.346,125.554z
					M138.897,131.271c4.413-10.802,8.809-21.728,13.213-32.637c2.715,5.2,5.521,10.409,8.309,15.715c0,0,0,0-0.099,0.09
					c-7.808,5.627-12.499,13.821-13.5,23.336c0,0,0,0,0,0.09c-1.304,0-2.607,0-3.904,0c-0.705-2.592-1.919-4.593-3.903-6.406
					C139.013,131.459,139.013,131.377,138.897,131.271z M165.028,123.363c-4.609,3.691-7.3,8.498-8.201,14.412c0,0,0,0.09,0,0.205
					c5.314,0,10.711,0,16.124,0c-2.624-4.913-5.216-9.811-7.824-14.822C165.127,123.158,165.127,123.257,165.028,123.363z
					M182.843,139.776c0.197,0.501,0.197,0.895,0.197,1.411c0,1.796-1.493,3.289-3.298,3.289c-7.603,0-15.206,0-22.817,0
					c0,0,0,0.099-0.098,0.213c1.706,11.303,11.507,19.711,22.915,19.711c12.812,0,23.22-10.417,23.22-23.213
					c0-12.705-10.408-23.131-23.22-23.131c-2.493,0-5.298,0.5-7.709,1.304C175.642,126.177,179.25,132.969,182.843,139.776z
					M122.687,130.155c-1.082-2.19-2.189-4.396-3.289-6.587c-1.817,0-3.613,0-5.409,0c0-1.419,0-2.928,0-4.413c1.202,0,2.399,0,3.703,0
					c0,0,0,0,0.098-0.106c0.591-0.706,1.395-0.993,2.403-0.993c0.89,0,1.809,0.394,2.395,0.993c0,0,0,0,0,0.106c1.493,0,3.104,0,4.704,0
					c0,1.403,0,2.904,0,4.413c-1.395,0-2.805,0-4.199,0c0.796,1.682,1.693,3.396,2.6,5.192c0.099,0,0.205-0.106,0.296-0.188
					c1.304-0.402,2.706-0.607,4.117-0.607c0.09,0,0.278,0,0.492,0c0,0,0,0,0.114,0c4.199-10.31,8.383-20.612,12.599-30.922
					c-19.824,0-39.722,0-59.652,0c-0.5,2.083-1.099,4.208-1.702,6.397c13.217,9.105,26.521,18.217,39.833,27.42
					C122.092,130.672,122.396,130.467,122.687,130.155z"/>
			</g>
			<!-- Text -->
			<g id="GIVE_WAY" transform="translate(-51.43, -34.29) scale(1.43) translate(0, 20)"><!-- translate(0, 40) class="darktext" -->
				<path d="M128.997,97.582h-6.279l-7.938,24.777h5.118l1.428-4.449h2.882h6.279l1.476,4.449h5.041L128.997,97.582z
					M124.829,113.472h-2.111l3.174-9.702l3.164,9.702H124.829z"/>
				<polyline points="95.119,97.582 93.106,97.582 89.808,114.137 85.954,97.582 80.777,97.582 86.374,122.359 
					92.427,122.359 95.926,104.241 99.579,122.359 105.632,122.359 111.152,97.582 105.892,97.582 102.264,114.137 98.688,97.582 
					95.119,97.582 "/>
				<polyline points="142.659,97.582 139.444,97.582 147.641,112.329 147.641,122.359 152.5,122.359 152.5,112.387 
					160.646,97.582 155.049,97.582 150.082,107.196 145.019,97.582 142.659,97.582 "/>
				<polyline points="165.365,44.241 153.106,44.241 153.106,81.677 178.487,81.677 178.487,74.674 160.427,74.674 
					160.427,66.393 175.725,66.393 175.725,59.452 160.427,59.452 160.427,51.251 177.406,51.251 177.406,44.241 165.365,44.241 "/>
				<path d="M78.955,56.369l6.94-3.105c-2.356-4.646-7.803-9.629-15.485-9.629c-7.751,0-17.64,5.669-17.64,18.93
					c0,13.33,9.625,19.448,17.571,19.448c5.26,0,8.764-2.279,9.428-2.75v2.415h6.656V60.34H70.476v6.111h9.293
					c0,3.711-3.306,8.771-9.359,8.771c-6.053,0-9.973-5.268-9.973-12.464c0-7.131,4.314-11.851,9.567-11.851
					S77.749,53.871,78.955,56.369"/>
				<rect x="98.089" y="44.241" width="7.474" height="37.436"/>
				<polyline points="130.005,81.677 134.242,81.677 144.617,44.241 136.668,44.241 129.128,71.518 121.438,44.241 
					113.508,44.241 124.014,81.677 130.005,81.677 "/>		
			</g>
			<g id="STOP"><!--  class="lighttext" -->
				<path d="M143.037,93.721c-14.347,0-26.527,11.823-26.527,28.609s11.599,29.094,26.527,29.094
					s26.511-12.308,26.511-29.094S157.367,93.721,143.037,93.721z M143.037,142.891c-11.303,0-16.676-11.593-16.676-20.421
					c0-8.919,5.562-19.979,16.676-19.979c11.106,0,16.652,11.06,16.652,19.979C159.689,131.298,154.373,142.891,143.037,142.891z"/>
				<path d="M200.898,102.967h-9.252v18.543h9.975c5.02,0,8.907-4.479,8.907-9.337
					C210.528,107.283,206.82,102.967,200.898,102.967 M204.254,129.755h-12.607v20.307h-9.499V94.681h21.639
					c9.121,0,16.355,9.074,16.355,18.033C220.142,120.968,212.137,129.755,204.254,129.755z"/>
				<path d="M62.143,102.64l-7.465,5.595c-3.1-3.036-7.046-6.515-13.256-6.515c-6.135,0-10.326,3.644-10.376,7.598
					c-0.074,5.489,4.061,6.761,12.247,8.196c5.725,0.928,9.975,1.461,14.084,4.693c3.766,3.004,5.783,7.114,5.783,12.02
					c0,4.956-3.281,17.197-21.016,17.197c-14.043,0-20.909-7.811-23.337-10.806l8.244-6.096c3.511,5.611,9.777,8.483,14.19,8.483
					c4.43,0,12.025-1.674,12.025-8.599c0-6.875-8.252-7.351-16.135-8.721c-7.826-1.371-16.003-5.325-16.003-16.082
					c0-10.739,10.639-15.941,20.292-15.941C51.151,93.663,57.91,96.879,62.143,102.64"/>
				<polyline points="89.564,150.062 93.937,150.062 93.937,103.345 108.8,103.345 108.8,94.681 69.312,94.681 
					69.312,103.345 84.191,103.345 84.191,150.062 89.564,150.062 "/>
			</g>
			<g id="40"><!--  class="darktext" -->
				<path d="M103,132v-9.303V75H80.517L37,132.554V148h48v16h18v-16h12v-16H103z M85,123.911V132H56.799L85,94.666V123.911z
					"/>
				<path d="M169.016,74.435c-12.739-0.148-37.493,7.208-37.493,45.923c0,38.727,23.389,46.458,37.493,46.458
					c14.104,0,37.502-7.73,37.502-46.458C206.518,81.644,181.754,74.287,169.016,74.435z M169.016,149.911
					c-10.684,0-19.467-7.061-19.17-30.158c0.361-23.175,9.77-28.644,19.17-28.644c9.392,0,18.775,5.469,19.162,28.644
					C188.482,142.851,179.682,149.911,169.016,149.911z"/>
			</g>
		</defs>
		<xsl:variable name="darkBackgrounds" select="'blue red green'" />
		<!-- Different shapes may have different space available for symbols. -->
		<xsl:variable name="smallSymbols" select="'inverted triangle'" />
		<xsl:variable name="offsetTop" select="'inverted triangle'" />
		<xsl:variable name="offsetBottom" select="'triangle'" />
		<xsl:apply-templates>
			<xsl:with-param name="symbolTextClass"><!-- light on dark, dark on light -->
				<xsl:choose>
					<xsl:when test="contains($darkBackgrounds, rsml:background/@colour)">
						<xsl:text>lighttextsymbol</xsl:text>
					</xsl:when>
					<xsl:otherwise>
						<xsl:text>darktextsymbol</xsl:text>
					</xsl:otherwise>
				</xsl:choose>
			</xsl:with-param>
			<xsl:with-param name="offsetY">
				<xsl:choose>
					<xsl:when test="contains($offsetBottom, rsml:shape/@geometry)">40</xsl:when>
					<xsl:when test="contains($offsetTop, rsml:shape/@geometry)">-58</xsl:when>
					<xsl:otherwise>0</xsl:otherwise>
				</xsl:choose>
			</xsl:with-param>
			<xsl:with-param name="scale">
				<xsl:choose>
					<xsl:when test="contains($smallSymbols, rsml:shape/@geometry)">0.7</xsl:when>
					<xsl:otherwise>1</xsl:otherwise>
				</xsl:choose>
			</xsl:with-param>
		</xsl:apply-templates>
	</xsl:template>
	<xsl:template match="rsml:shape">
		<use xlink:href="#{translate(@geometry, ' ', '_')}" class="shape" /><!-- class="shape"-->
	</xsl:template>
	<xsl:template match="rsml:symbol">
		<xsl:param name="symbolTextClass" />
		<xsl:param name="offsetY" />
		<xsl:param name="scale" />
		<xsl:if test="not(@sybolId = 'none')">
			<xsl:variable name="tX" select="-1 * $centreX * ($scale - 1)" />
			<xsl:variable name="tY" select="-1 * $centreY * ($scale - 1)" />
			<!-- Match the symbol to the SVG shape ID,
				replacing spaces with underscores (IDs cannot have spaces).-->
			<use xlink:href="#{translate(@symbolId, ' ', '_')}" class="{$symbolTextClass}" transform="translate({$tX},{$tY}) 
				scale({$scale}) translate(0, {$offsetY})" />
		</xsl:if>
	</xsl:template>
	<xsl:template match="rsml:text">
		<xsl:param name="symbolTextClass" />
		<xsl:param name="offsetY" />
		<xsl:param name="scale" />
		<xsl:if test="not(@value = 'none')">
			<xsl:variable name="tX" select="-1 * $centreX * ($scale - 1)" />
			<xsl:variable name="tY" select="-1 * $centreY * ($scale - 1)" />
			<!-- Match the text to the SVG text ID,
				replacing spaces with underscores (IDs cannot have spaces).-->
			<use xlink:href="#{translate(@value, ' ', '_')}" class="{$symbolTextClass}" transform="translate({$tX},{$tY}) scale({$scale}) translate(0, {$offsetY})" />
		</xsl:if>
	</xsl:template>
</xsl:stylesheet>
